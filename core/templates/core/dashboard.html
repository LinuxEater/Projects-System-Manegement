{% extends 'core/base.html' %}

{% block title %}Dashboard - Freelance Manager{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-bold text-gray-800">Dashboard</h1>
        <div class="flex items-center justify-center md:justify-end space-x-2">
            <a href="{% url 'dashboard' %}?filter=week" class="btn btn-sm {% if request.GET.filter == 'week' %}btn-primary{% else %}btn-outline-secondary{% endif %}">This Week</a>
            <a href="{% url 'dashboard' %}?filter=month" class="btn btn-sm {% if request.GET.filter == 'month' %}btn-primary{% else %}btn-outline-secondary{% endif %}">This Month</a>
            <a href="{% url 'dashboard' %}" class="btn btn-sm {% if not request.GET.filter %}btn-primary{% else %}btn-outline-secondary{% endif %}">All Time</a>
        </div>
    </div>

    <!-- KPIs Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-gray-500 text-sm font-medium">Total Revenue</h2>
            <p class="text-3xl font-bold text-green-600">R$ {{ total_revenue|floatformat:2 }}</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-gray-500 text-sm font-medium">Completed Projects</h2>
            <p class="text-3xl font-bold">{{ total_completed_projects }}</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-gray-500 text-sm font-medium">In Progress</h2>
            <p class="text-3xl font-bold">{{ in_progress_projects }}</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-gray-500 text-sm font-medium">Pending</h2>
            <p class="text-3xl font-bold">{{ pending_projects }}</p>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Monthly Earnings Chart -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h3 class="font-semibold mb-4">Monthly Earnings</h3>
            <canvas id="monthlyEarningsChart"></canvas>
        </div>

        <!-- Project Status Distribution -->
        <div class="bg-white p-6 rounded-lg shadow-lg flex items-center justify-center">
            <div>
                <h3 class="font-semibold mb-4 text-center">Project Status</h3>
                <canvas id="statusDistributionChart" style="max-width: 300px; margin: auto;"></canvas>
            </div>
        </div>

        <!-- Top Projects by Value -->
        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
            <h3 class="font-semibold mb-4">Top 10 Projects by Revenue</h3>
            <canvas id="perProjectEarningsChart"></canvas>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Monthly Earnings Chart (Bar)
        const monthlyCtx = document.getElementById('monthlyEarningsChart').getContext('2d');
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: {{ monthly_chart_labels|safe }},
                datasets: [{
                    label: 'Earnings',
                    data: {{ monthly_chart_data|safe }},
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                return 'R$ ' + value;
                            }
                        }
                    }
                }
            }
        });

        // Per Project Earnings Chart (Horizontal Bar)
        const perProjectCtx = document.getElementById('perProjectEarningsChart').getContext('2d');
        new Chart(perProjectCtx, {
            type: 'bar',
            data: {
                labels: {{ per_project_chart_labels|safe }},
                datasets: [{
                    label: 'Revenue',
                    data: {{ per_project_chart_data|safe }},
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                return 'R$ ' + value;
                            }
                        }
                    }
                }
            }
        });

        // Status Distribution Chart (Doughnut)
        const statusCtx = document.getElementById('statusDistributionChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: {{ status_chart_labels|safe }},
                datasets: [{
                    label: 'Project Status',
                    data: {{ status_chart_data|safe }},
                    backgroundColor: [
                        'rgba(255, 206, 86, 0.7)', // Pending
                        'rgba(54, 162, 235, 0.7)', // In Progress
                        'rgba(75, 192, 192, 0.7)'  // Completed
                    ],
                    borderColor: [
                        'rgba(255, 206, 86, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 1
                }]
            }
        });
    });
</script>
{% endblock %}
